---
title: "brazilian-ecommerce 02_Review Analysis"
author: "Tina"
date: "`r Sys.time()`"
output: html_document
---

<br>

```{r echo=T, message=F, cache=F, warning=F}
rm(list=ls(all=T))
Sys.setlocale("LC_ALL","C")
library(dplyr)
library(ggplot2)
library(caTools)

load("rdata/Z.rdata")
```
<br><hr>


### 【A】 Prod

##### 跟 Review 一起看
```{r}
Y = OrdRev %>% select(review_id, order_id, review_score, comment_length, answer_delay) %>% 
  left_join(., OrdItm[, c("order_id", "product_id")], by = "order_id") %>% 
  right_join(., Prod, by = "product_id")

# 移除重複的資料
Y = Y[!duplicated(Y),]

n_distinct(Y$product_id)
str(Y)
```


##### 找出高利潤商品分類

依據分類group_by
```{r}
Prod_cat = Y %>% 
  group_by(product_category_name_english) %>% 
  summarise(noProd = n(),
            noPurchase = sum(noPurchase),              # 被購買次數
            revenue = sum(revenue),                    # 總獲利
            RevPerProd = revenue/noPurchase,           # 商品平均獲利
            photos_qty = mean(product_photos_qty),     # 平均圖片數量
            avg_review_score = mean(review_score),     # 平均評論分數
            avg_comment_length = mean(comment_length), # 平均評論長度
            avg_answer_delay = mean(answer_delay)      # 平均評論回覆天數
            )  

# 選出前十名
HighRevenueProd = Prod_cat[order(Prod_cat$RevPerProd, decreasing = T),"product_category_name_english"] %>% head(10) 

Prod_cat$HighRevenueProd = ifelse(
  Prod_cat$product_category_name_english %in% HighRevenueProd$product_category_name_english,
  1, 0)

```


##### 高利潤商品類別的評論分數是否有比較高?

* use t.test 

```{r}
boxplot(avg_review_score ~ HighRevenueProd, data = Prod_cat)

t.test(Prod_cat$avg_review_score ~ Prod_cat$HighRevenueProd)

# p-value =  0.09296
# p-value > 0.05
# 不拒絕「高利潤商品的avg_review_score的相等」的虛無假設
```

### 【B】80/20法則、長尾理論

##### Long-Tail Thoery
```{r}
Prod = Prod[order(Prod$revenue, decreasing = T),]
Prod$id = seq(1, nrow(Prod), 1)
```



```{r}
Prod %>%
  filter(revenue > 3000) %>%
  ggplot(aes(id, revenue)) + geom_point() + geom_smooth(method="lm")
```

### 【C】低分評論的原因

##### Ord + OrdRev

```{r}
OR = OrdRev %>% left_join(., Ord, by = "order_id") 

# 移除重複的資料
OR = OR[!duplicated(OR),]
```

只有97256筆交易有評論
```{r}
n_distinct(Y$order_id)  # 97256
```


查看na值
```{r}
colSums(is.na(OR))
```

##### 看一下 review_score 的分布

* **57.42%**的交易都為5星
* **76.62%**的交易都可以獲得4星以上評論分數
* **11.86%**的交易獲得1星
```{r}
OR$review_score %>% table %>% prop.table()
0.19200 + 0.57420
0.11858+0.03235
```

```{r}
OR %>% ggplot(aes(review_score)) + geom_histogram(aes(y=..count..), binwidth=0.5)
```


##### 增加low_score的欄位
有15.093%的交易評分得到1or2顆星
```{r}
OR$low_score = sapply(OR$review_score, function(x){
  ifelse(x<4, TRUE, FALSE)
  })

prop.table(table(OR$low_score))
```


##### 運送時間 v.s. 低評分

```{r}
OR = filter(OR, delivery_days>0 , delivery_days<100)
summary(OR$delivery_days)
```




探討問題：低評分的交易運送時間是否與高評分的交易運送時間有顯著差異

使用t.test檢定
H0: 低評分交易與高評分交易的delivery_days相等
H1: 低評分交易與高評分交易的delivery_days不相等

```{r}
t.test(OR$delivery_days ~ OR$low_score)

# p-value < 0.05
# 拒絕「高利潤商品的avg_review_score的相等」的虛無假設
```

```{r}
OR %>% ggplot(aes(delivery_days, fill = low_score)) + 
  geom_histogram(aes(y = ..density..),position = "dodge") + 
  xlim(0, 100)
```


```{r}
mean(OR[OR$low_score==F, "delivery_days"])
mean(OR[OR$low_score==T, "delivery_days"])
```

##### 最好控制在多久的運送時間?

```{r}
hist(OR[OR$low_score==T, "delivery_days"])
```


p-value = 0 ...............?

```{r}
fit = goodfit(OR[OR$low_score==T, "delivery_days"], type = "poisson")
summary(fit)
```






<br><br><br>
---



<br><br><br><br><hr><br><br><br>

<style>
.caption {
  color: #777;
  margin-top: 10px;
}
p code {
  white-space: inherit;
}
pre {
  word-break: normal;
  word-wrap: normal;
  line-height: 1;
}
pre code {
  white-space: inherit;
}
p,li {
  font-family: "Trebuchet MS", "微軟正黑體", "Microsoft JhengHei";
}

.r{
  line-height: 1.2;
}

title{
  color: #cc0000;
  font-family: "Trebuchet MS", "微軟正黑體", "Microsoft JhengHei";
}

body{
  font-family: "Trebuchet MS", "微軟正黑體", "Microsoft JhengHei";
}

h1,h2,h3,h4,h5{
  color: #008800;
  font-family: "Trebuchet MS", "微軟正黑體", "Microsoft JhengHei";
}

h3{
  color: #b36b00;
  background: #ffe0b3;
  line-height: 2;
  font-weight: bold;
}

h5{
  color: #006000;
  background: #ffffe0;
  line-height: 2;
  font-weight: bold;
}

em{
  color: #0000c0;
  background: #f0f0f0;
  }
</style>

